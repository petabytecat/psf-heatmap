# PSF Heatmap Analysis

### Data Source: *MetroloJ_QC (ImageJ / Fiji)*

---

## Overview

This module processes and visualizes **Point Spread Function (PSF)** data obtained from the *MetroloJ_QC* plugin in **ImageJ/Fiji**.
It generates **heatmaps** and **summary statistics** that describe the optical performance of a microscope across the field of view, based on FWHM (Full Width at Half Maximum) ratios and lateral asymmetry measurements from fluorescent bead images.

---

## Purpose

* Assess microscope performance and uniformity.
* Identify optical aberrations or field-dependent PSF distortions.
* Visualize PSF quality variations as interpolated 2D heatmaps.

---

## Requirements

* `numpy`
* `matplotlib`
* `pandas`
* `dataclasses`
* `re`, `os`, `csv` (standard Python libraries)

---

## Input Data Structure

The pipeline expects a folder structure created by *MetroloJ_QC*:

```
root_directory/
└── PSFData/
    └── 63X_1_4_525/
        ├── 63X_1_4_525_data/
        │   └── 63X_1_4_525_BatchRawData.xls
        ├── Image 1/
        │   ├── bead1/
        │   │   └── 63X_1_4_525_Image 1_bead1_results.xls
        │   └── bead2/
        └── Image 2/
            ├── bead1/
            └── bead2/
```

Each bead folder contains `.xls` files exported by **MetroloJ_QC**, with PSF data (FWHM, asymmetry, and fit quality).

---

## Workflow Summary

### 1. **Data Extraction**

* Reads raw PSF and bead metadata from MetroloJ’s `BatchRawData.xls`.
* Extracts:

  * Measured and theoretical FWHM (X, Y, Z)
  * Fit goodness (R² values)
  * Lateral asymmetry
  * Bead coordinates and validity flags

---

### 2. **Filtering**

Beads are categorized as:

* **Valid beads:** all dimensions valid and complete.
* **Invalid beads:** one or more invalid or missing measurements.

Minimum of `MIN_POINTS = 5` valid beads are required to generate heatmaps.

---

### 3. **Interpolation (IDW Method)**

Uses **Inverse Distance Weighting (IDW)** interpolation to estimate PSF metrics across the full field of view.
The interpolation power and resolution are configurable (default power = 2, resolution = 100).

---

### 4. **Visualization**

Generates **heatmaps** for:

* X, Y, and Z FWHM / Theoretical ratios
* Lateral Asymmetry

Each heatmap includes:

* Scatter overlay of valid and invalid bead positions
* Customizable color maps
* Automatic colorbars and field scaling

Output example:

```
63X_1_4_525_data/
    └── 63X_1_4_525_Heatmaps_Summary.png
```

---

### 5. **Data Export**

Two main CSV files are generated:

#### a. **Raw Data Table**

Contains all bead-level data (measured FWHM, theoretical FWHM, ratios, fit metrics, coordinates, validity).

```
63X_1_4_525_Heatmap_RawData.csv
```

#### b. **Summary Statistics**

Reports averages and standard deviations for:

* Measured and theoretical FWHM (X/Y/Z)
* Measured-to-theoretical FWHM ratios
* Lateral asymmetry ratios

```
63X_1_4_525_Summary.csv
```

---

## Example Outputs

| File                               | Description                                  |
| ---------------------------------- | -------------------------------------------- |
| `63X_1_4_525_Heatmaps_Summary.png` | Heatmaps of PSF quality (X, Y, Z, asymmetry) |
| `63X_1_4_525_Heatmap_RawData.csv`  | All bead-level PSF data                      |
| `63X_1_4_525_Summary.csv`          | Aggregate metrics summary                    |
| `63X_1_4_525_Image1_Summary.csv`   | Per-image summary                            |

---

## Key Parameters

| Parameter                       | Description               | Default         |
| ------------------------------- | ------------------------- | --------------- |
| `DEFAULT_MAIN_DIR`              | Root folder for PSF data  | `"PSFData"`     |
| `DEFAULT_IMAGES_DIR`            | Microscope setup name     | `"63X_1_4_525"` |
| `DEFAULT_INTERPOLATION_POWER`   | IDW power factor          | `2`             |
| `DEFAULT_RESOLUTION`            | Heatmap grid resolution   | `100`           |
| `MIN_POINTS`                    | Minimum valid beads       | `5`             |
| `DEFAULT_COLORMAP`              | Colormap type             | `"turbo"`       |
| `DEFAULT_VMIN` / `DEFAULT_VMAX` | Color limits for heatmaps | `0 / 2`         |

---

## Output Directory Structure

```
PSFData/
└── 63X_1_4_525/
    ├── 63X_1_4_525_data/
    │   ├── 63X_1_4_525_Heatmap_RawData.csv
    │   ├── 63X_1_4_525_Heatmaps_Summary.png
    │   └── 63X_1_4_525_Summary.csv
    └── Image 1/
        └── 63X_1_4_525_data/
            └── 63X_1_4_525_Image 1_Summary.csv
```

---

## Notes

* This analysis assumes data generated by **MetroloJ_QC v1.3+**.
* Designed for PSF characterization using **sub-resolution fluorescent beads**.
* Compatible with datasets from **confocal, widefield, or multiphoton** systems.
